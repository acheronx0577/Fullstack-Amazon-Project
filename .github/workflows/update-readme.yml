name: ğŸ“š Update README with Daily Fact

on:
  schedule:
    # Runs daily at 4 PM UTC (8 AM PST / 11 AM EST)
    - cron: "0 16 * * *"
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      debug:
        description: "Enable debug output"
        required: false
        default: false
        type: boolean

jobs:
  update-readme:
    name: ğŸ—“ï¸ Update Daily Fact
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT || github.token }}
          fetch-depth: 0

      # Step 2: Setup Git configuration
      - name: âš™ï¸ Setup Git Identity
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false

      # Step 3: Sync with remote before making changes
      - name: ğŸ”„ Sync with Remote
        run: |
          echo "ğŸ”„ Pulling latest changes from remote..."
          git pull origin main
          echo "âœ… Successfully synced with remote"

      # Step 4: Get current date information
      - name: ğŸ“… Get Current Date
        id: date
        run: |
          echo "date_slash=$(date +'%m/%d')" >> $GITHUB_OUTPUT
          echo "date_display=$(date +'%B %d')" >> $GITHUB_OUTPUT
          echo "iso_date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "weekday=$(date +'%A')" >> $GITHUB_OUTPUT

      # Step 5: Fetch daily fact from API
      - name: ğŸŒ Fetch Daily Fact
        id: fact
        run: |
          set +e
          echo "ğŸ¯ Fetching fact for date: ${{ steps.date.outputs.date_slash }}"
          echo "ğŸ“… Today is ${{ steps.date.outputs.date_display }} (${{ steps.date.outputs.weekday }})"
          
          # Try Numbers API first
          echo "ğŸ” Trying Numbers API..."
          FACT_JSON=$(curl -s --max-time 10 --retry 2 "http://numbersapi.com/${{ steps.date.outputs.date_slash }}/date?json")
          FACT=$(echo "$FACT_JSON" | jq -r '.text // empty' 2>/dev/null)
          
          # Validate the fact
          if [ -n "$FACT" ] && [ "$FACT" != "null" ] && [[ ! "$FACT" =~ "does not exist" ]]; then
            echo "âœ… Successfully fetched from Numbers API"
          else
            echo "âŒ Numbers API failed, trying random date fact..."
            FACT_JSON=$(curl -s --max-time 10 "http://numbersapi.com/random/date?json")
            FACT=$(echo "$FACT_JSON" | jq -r '.text // empty' 2>/dev/null)
            
            if [ -n "$FACT" ] && [ "$FACT" != "null" ]; then
              echo "âœ… Successfully fetched random date fact"
            else
              echo "âŒ All APIs failed, using inspirational fallback"
              FACT="On this day in history, remarkable things happened that shaped our world. Every day is a new opportunity for learning and growth! ğŸŒŸ"
            fi
          fi
          
          # Clean and format the fact
          FACT=$(echo "$FACT" | tr -d '\r' | sed 's/^"//' | sed 's/"$//')
          echo "ğŸ“– Fact: $FACT"
          
          # Escape for sed and create outputs
          ESCAPED_FACT=$(printf '%s' "$FACT" | sed 's/[\/&]/\\&/g')
          echo "fact=$FACT" >> $GITHUB_OUTPUT
          echo "escaped_fact=$ESCAPED_FACT" >> $GITHUB_OUTPUT

      # Step 6: Update README file
      - name: ğŸ“ Update README
        run: |
          echo "ğŸ”„ Updating README.md..."
          
          # Create backup
          cp README.md README.md.backup
          
          # Update the daily fact section to use code block format
          if sed -i "s|<!-- DAILY_FACT -->.*|<!-- DAILY_FACT -->\n\`\`\`plaintext\nğŸ“Œ Daily Fact: ${{ steps.fact.outputs.fact }}\n\`\`\`|" README.md; then
            echo "âœ… README updated successfully"
            
            # Show the change
            echo "ğŸ“Š Change made:"
            git diff README.md || true
          else
            echo "âŒ Failed to update README, restoring backup"
            mv README.md.backup README.md
            exit 1
          fi
          
          # Cleanup backup
          rm README.md.backup

      # Step 7: Commit and push changes with merge strategy
      - name: ğŸš€ Commit and Push Changes
        run: |
          echo "ğŸ“¦ Staging changes..."
          git add README.md
          
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit (fact might be identical)"
          else
            echo "ğŸ’¾ Committing changes..."
            git commit -m "ğŸ“š Update daily fact for ${{ steps.date.outputs.iso_date }}
            
            â€¢ Date: ${{ steps.date.outputs.date_display }}
            â€¢ Fact: ${{ steps.fact.outputs.fact }}"
            
            echo "ğŸ“¤ Pushing to repository..."
            
            # Merge strategy: Pull remote changes and merge
            echo "ğŸ”„ Pulling latest changes and merging..."
            git fetch origin
            git merge origin/main --no-edit -m "Merge remote changes"
            
            # Push the merged result
            git push origin main
            
            echo "ğŸ‰ Successfully updated daily fact!"
          fi

      # Step 8: Summary
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo " "
          echo "ğŸ WORKFLOW SUMMARY"
          echo "===================="
          echo "ğŸ“… Date: ${{ steps.date.outputs.date_display }}"
          echo "ğŸ“– Fact: ${{ steps.fact.outputs.fact }}"
          echo "ğŸ•’ Time: $(date -u +'%H:%M:%S UTC')"
          echo "âœ… Status: ${{ job.status }}"
          echo " "
